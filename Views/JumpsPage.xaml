<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="BaseLogApp.Views.JumpsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:converters="clr-namespace:BaseLogApp.Converters"
    Title="{Binding PageTitle}"
    BackgroundColor="{AppThemeBinding Light=#FAFAFA, Dark=#111111}">

  <ContentPage.Resources>
    <converters:DateToLocalStringConverter x:Key="DateToLocal" Format="dd MMM yyyy" />
    <converters:NullOrEmptyToBoolConverter x:Key="HasText" />
  </ContentPage.Resources>

  <Grid Padding="16,12,16,0" RowSpacing="12">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
    </Grid.RowDefinitions>

    <Frame Grid.Row="0" Padding="0" CornerRadius="8" BorderColor="{AppThemeBinding Light=#DDD, Dark=#444}" BackgroundColor="{AppThemeBinding Light=White, Dark=#1C1C1C}">
        <SearchBar 
               Placeholder="Filtra salti..."
               Text="{Binding SearchText}"
               BackgroundColor="Transparent"
               TextColor="{AppThemeBinding Light=Black, Dark=White}" />
    </Frame>

    <CollectionView Grid.Row="1"
        ItemsSource="{Binding Jumps}"
        SelectionMode="None"
        ItemSizingStrategy="MeasureAllItems"
        EmptyView="Nessun salto registrato.">
      <CollectionView.ItemsLayout>
        <LinearItemsLayout Orientation="Vertical" ItemSpacing="12" />
      </CollectionView.ItemsLayout>

      <CollectionView.ItemTemplate>
        <DataTemplate>
          <Frame Padding="0" Margin="0,0,0,0" CornerRadius="12" HasShadow="False" BackgroundColor="{AppThemeBinding Light=White, Dark=#1C1C1C}">
            <toolkit:Expander IsExpanded="{Binding IsExpanded}">
              <!-- HEADER -->
              <toolkit:Expander.Header>
                <Grid Padding="16">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                  </Grid.ColumnDefinitions>
                  <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                  </Grid.RowDefinitions>

                  <Label Grid.RowSpan="2" Grid.Column="0"
                         Text="{Binding JumpNumber}"
                         FontSize="32"
                         FontAttributes="Bold"
                         Margin="0,0,16,0"
                         VerticalTextAlignment="Center"
                         TextColor="{AppThemeBinding Light=#1A73E8, Dark=#8AB4F8}" />

                  <HorizontalStackLayout Grid.Row="0" Grid.Column="1" Spacing="8">
                    <Label Text="{Binding ExitName}"
                           FontSize="18"
                           FontAttributes="Bold"
                           LineBreakMode="TailTruncation"
                           TextColor="{AppThemeBinding Light=Black, Dark=White}" />
                    <Label Text="{Binding JumpTypeName}"
                           IsVisible="{Binding HasJumpType}"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light=#888, Dark=#AAA}" />
                  </HorizontalStackLayout>

                  <HorizontalStackLayout Grid.Row="1" Grid.Column="1" Spacing="10">
                    <Label Text="{Binding JumpDateUtc, Converter={StaticResource DateToLocal}}"
                           Opacity="0.85"
                           TextColor="{AppThemeBinding Light=#444, Dark=#BBB}" />
                    <Label Text="{Binding LocationName}"
                           IsVisible="{Binding LocationName, Converter={StaticResource HasText}}"
                           Opacity="0.85"
                           TextColor="{AppThemeBinding Light=#444, Dark=#BBB}" />
                  </HorizontalStackLayout>

                  <Frame Grid.RowSpan="2" Grid.Column="2"
                               Padding="0"
                               CornerRadius="8"
                               IsClippedToBounds="True"
                               x:Name="ThumbHost"
                               BackgroundColor="{AppThemeBinding Light=#EEE, Dark=#2A2A2A}">
                    <Image WidthRequest="64" HeightRequest="64"
                           Aspect="AspectFill"
                           Source="{Binding Thumbnail}" />
                  </Frame>

                  <Grid.Triggers>
                    <DataTrigger TargetType="Grid" Binding="{Binding Thumbnail}" Value="{x:Null}">
                      <Setter TargetName="ThumbHost" Property="IsVisible" Value="False" />
                    </DataTrigger>
                  </Grid.Triggers>
                </Grid>
              </toolkit:Expander.Header>

              <!-- CONTENUTO ESPANSO -->
              <toolkit:Expander.Content>
                <Grid Padding="16" BackgroundColor="{AppThemeBinding Light=#F7F7F7, Dark=#222222}">
                  <VerticalStackLayout Spacing="12">
                    <Label Text="{Binding Notes}"
                           IsVisible="{Binding Notes, Converter={StaticResource HasText}}"
                           TextColor="{AppThemeBinding Light=#222, Dark=#DDD}" />
                    
                    <BoxView HeightRequest="1" Color="{AppThemeBinding Light=#EEE, Dark=#333}" Margin="0,4" />

                    <HorizontalStackLayout Spacing="8" HorizontalOptions="End">
                      <Button Text="Modifica"
                              Style="{StaticResource TextButton}"
                              Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EditCommand}"
                              CommandParameter="{Binding .}" />
                      <Button Text="Mappa"
                              Style="{StaticResource TextButton}"
                              IsEnabled="{Binding HasCoordinates}"
                              Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ShowMapCommand}"
                              CommandParameter="{Binding .}" />
                      <Button Text="Elimina"
                              Style="{StaticResource TextButton}"
                              TextColor="{AppThemeBinding Light=#C00, Dark=#F88}"
                              Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteCommand}"
                              CommandParameter="{Binding .}" />
                    </HorizontalStackLayout>
                  </VerticalStackLayout>
                </Grid>
              </toolkit:Expander.Content>
            </toolkit:Expander>
          </Frame>
        </DataTemplate>
      </CollectionView.ItemTemplate>
    </CollectionView>
  </Grid>
</ContentPage>
