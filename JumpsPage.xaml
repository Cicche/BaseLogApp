<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="BaseLog.Views.JumpsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:converters="clr-namespace:BaseLog.Converters"
    xmlns:maps="clr-namespace:Microsoft.Maui.Controls.Maps;assembly=Microsoft.Maui.Controls.Maps"
    Title="Salti">

    <ContentPage.Resources>
        <converters:DateToLocalStringConverter x:Key="DateToLocal" Format="dd MMM yyyy" />
        <converters:NullOrEmptyToBoolConverter x:Key="HasText" />
        <converters:FilePathToImageSourceConverter x:Key="FileToImage" />
    </ContentPage.Resources>

    <CollectionView
      ItemsSource="{Binding Jumps}"
      SelectionMode="None"
      ItemSizingStrategy="MeasureAllItems"
      EmptyView="Nessun salto registrato.">
        <CollectionView.ItemsLayout>
            <LinearItemsLayout Orientation="Vertical" ItemSpacing="8" />
        </CollectionView.ItemsLayout>

        <CollectionView.ItemTemplate>
            <DataTemplate>
                <Frame Margin="12,6" Padding="12" HasShadow="True" CornerRadius="14">
                    <toolkit:Expander IsExpanded="{Binding IsExpanded}"
                            ExpandAnimationEasing="SinOut"
                            CollapseAnimationEasing="SinIn">
                        <toolkit:Expander.Header>
                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                                <VerticalStackLayout Grid.Column="0" Spacing="2">
                                    <Label Text="{Binding ExitName}" FontAttributes="Bold" LineBreakMode="TailTruncation"/>
                                    <HorizontalStackLayout Spacing="10">
                                        <Label Text="{Binding ObjectName}" Opacity="0.7" IsVisible="{Binding ObjectName, Converter={StaticResource HasText}}"/>
                                        <Label Text="{Binding JumpDateUtc, Converter={StaticResource DateToLocal}}" Opacity="0.7"/>
                                        <Label Text="{Binding LocationName}" Opacity="0.7" IsVisible="{Binding LocationName, Converter={StaticResource HasText}}"/>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>

                                <Border Grid.Column="1" StrokeShape="RoundRectangle 8"
                        BackgroundColor="{AppThemeBinding Light=#F1F1F1, Dark=#1E1E1E}">
                                    <Image WidthRequest="64" HeightRequest="64" Aspect="AspectFill"
                         Source="{Binding PhotoPath, Converter={StaticResource FileToImage}}"
                         IsVisible="{Binding PhotoPath, Converter={StaticResource HasText}}"/>
                                </Border>

                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ToggleExpandCommand}"
                                        CommandParameter="{Binding .}"/>
                                </Grid.GestureRecognizers>
                            </Grid>
                        </toolkit:Expander.Header>

                        <toolkit:Expander.Content>
                            <VerticalStackLayout Spacing="10" Margin="0,10,0,0">
                                <Label Text="{Binding Notes}" IsVisible="{Binding Notes, Converter={StaticResource HasText}}"/>

                                <HorizontalStackLayout Spacing="16">
                                    <Label Text="{Binding GearSetup}" IsVisible="{Binding GearSetup, Converter={StaticResource HasText}}" />
                                    <Label Text="{Binding ExitHeight, StringFormat='Altezza: {0} m'}" IsVisible="{Binding ExitHeight, Converter={StaticResource HasText}}" />
                                    <Label Text="{Binding DelaySeconds, StringFormat='Delay: {0} s'}" IsVisible="{Binding DelaySeconds, Converter={StaticResource HasText}}" />
                                </HorizontalStackLayout>

                                <HorizontalStackLayout Spacing="12">
                                    <Button Text="Modifica"
                          Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EditCommand}"
                          CommandParameter="{Binding .}" />
                                    <Button Text="Mappa"
                          IsEnabled="{Binding HasCoordinates}"
                          Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ShowMapCommand}"
                          CommandParameter="{Binding .}" />
                                    <Button Text="Elimina"
                          Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteCommand}"
                          CommandParameter="{Binding .}" />
                                </HorizontalStackLayout>

                                <maps:Map HeightRequest="160" IsVisible="{Binding ShowInlineMap}" MapType="Street">
                                    <maps:Map.Pins>
                                        <maps:Pin Label="{Binding ExitName}" Address="{Binding LocationName}"
                              Location="{Binding MapLocation}" />
                                    </maps:Map.Pins>
                                </maps:Map>
                            </VerticalStackLayout>
                        </toolkit:Expander.Content>
                    </toolkit:Expander>
                </Frame>
            </DataTemplate>
        </CollectionView.ItemTemplate>
    </CollectionView>
</ContentPage>
